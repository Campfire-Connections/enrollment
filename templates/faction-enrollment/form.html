<!-- enrollment/templates/faction-enrollment/form.html-->
{% extends "base/layout.html" %}

{% block content %}
<section class="container mt-5 card">
<h2>Enroll {{ faction.name | title }}.</h2>

<form method="POST" class="form-horizontal">
    {% csrf_token %}
    <fieldset>
    <!-- Facility Enrollment -->
    <div class="form-group">
        <label for="{{ form.facility_enrollment.id_for_label }}" class="control-label">
        {{ form.facility_enrollment.label }}
        </label>
        <div class="controls">
        {{ form.facility_enrollment }}
        </div>
    </div>

    <!-- Week -->
    <div class="form-group">
        <label for="{{ form.week.id_for_label }}" class="control-label">
        {{ form.week.label }}
        </label>
        <div class="controls">
        {{ form.week }}
        </div>
    </div>

    <!-- Quarters -->
    <div class="form-group">
        <label for="{{ form.quarters.id_for_label }}" class="control-label">
        {{ form.quarters.label }}
        </label>
        <div class="controls">
        {{ form.quarters }}
        </div>
    </div>

    <!-- Start Date -->
    <div class="form-group">
        <label for="{{ form.start_date.id_for_label }}" class="control-label">
        {{ form.start_date.label }}
        </label>
        <div class="controls">
        {{ form.start_date }}
        </div>
    </div>

    <!-- End Date -->
    <div class="form-group">
        <label for="{{ form.end_date.id_for_label }}" class="control-label">
        {{ form.end_date.label }}
        </label>
        <div class="controls">
        {{ form.end_date }}
        </div>
    </div>

    </fieldset>

    <div class="form-group">
    <button type="submit" class="btn btn-primary">Submit Enrollment</button>
    <a href="{% url 'factions:show' faction.slug %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>
</section>

<script>
(function() {
    const weekSelect = document.getElementById("id_week");
    const quartersSelect = document.getElementById("id_quarters");
    const facilitySelect = document.getElementById("id_facility_enrollment");

    function resetSelect(selectEl, placeholder) {
        if (!selectEl) return;
        selectEl.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = placeholder;
        selectEl.appendChild(opt);
    }

    async function loadWeeks(facilityEnrollmentId) {
        resetSelect(weekSelect, "Select Week");
        resetSelect(quartersSelect, "Select Quarters");
        if (!facilityEnrollmentId) return;
        const resp = await fetch(`{% url 'ajax_load_weeks' %}?facility_enrollment=${facilityEnrollmentId}`);
        const data = await resp.json();
        data.forEach((week) => {
            const opt = document.createElement("option");
            opt.value = week.id;
            opt.textContent = week.name;
            weekSelect.appendChild(opt);
        });
    }

    async function loadQuarters(facilityEnrollmentId, weekId) {
        resetSelect(quartersSelect, "Select Quarters");
        if (!facilityEnrollmentId || !weekId) return;
        const resp = await fetch(`{% url 'ajax_load_quarters' %}?facility_enrollment=${facilityEnrollmentId}&week=${weekId}`);
        const data = await resp.json();
        data.forEach((quarter) => {
            const opt = document.createElement("option");
            opt.value = quarter.id;
            opt.textContent = quarter.name;
            quartersSelect.appendChild(opt);
        });
    }

    facilitySelect?.addEventListener("change", (e) => {
        loadWeeks(e.target.value);
    });

    weekSelect?.addEventListener("change", (e) => {
        loadQuarters(facilitySelect?.value, e.target.value);
    });
})();
</script>
{% endblock %}
